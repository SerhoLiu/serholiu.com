upstream http_tornado {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
}

server {
    listen 80;
    server_name blog.cheyo.net cheyo.net www.cheyo.net localhost;
    client_max_body_size 4M;

    error_log   /opt/data/product/blog/log/nginx_error.log;
    access_log   /opt/data/product/blog/log/nginx_access.log;

    location ^~ /static {
        root /opt/data/product/blog/miniakio;
        if ($query_string) {
            expires max;
        }
    }

    location = /favicon.ico {
        rewrite (.*) /static/favicon.ico;
    }

    location = /robots.txt {
        rewrite (.*) /static/robots.txt;
    }

    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|html|htm|css)$ {
        root /opt/data/product/blog/cache;
        proxy_store on;
        proxy_store_access user:rw group:rw all:rw;
        proxy_temp_path /opt/data/product/blog/cache;
        if ( !-e $request_filename) {
            proxy_pass  http://http_tornado;
        }
    }

    location / {
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://http_tornado;
    }
}